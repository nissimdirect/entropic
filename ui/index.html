<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENTROPIC</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<!-- Boot Screen: visible immediately, dismissed when app.js init() completes -->
<div id="boot-screen">
    <div class="boot-logo">
        <pre class="boot-ascii">
 ███████╗███╗   ██╗████████╗██████╗  ██████╗ ██████╗ ██╗ ██████╗
 ██╔════╝████╗  ██║╚══██╔══╝██╔══██╗██╔═══██╗██╔══██╗██║██╔════╝
 █████╗  ██╔██╗ ██║   ██║   ██████╔╝██║   ██║██████╔╝██║██║
 ██╔══╝  ██║╚██╗██║   ██║   ██╔══██╗██║   ██║██╔═══╝ ██║██║
 ███████╗██║ ╚████║   ██║   ██║  ██║╚██████╔╝██║     ██║╚██████╗
 ╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═╝ ╚═════╝ ╚═╝     ╚═╝ ╚═════╝
        </pre>
        <div class="boot-tagline">data is fragile</div>
        <div class="boot-cursor">loading<span class="blink">_</span></div>
    </div>
    <style>
        #boot-screen {
            position: fixed;
            inset: 0;
            background: #050506;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease;
        }
        #boot-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .boot-logo {
            text-align: center;
        }
        .boot-ascii {
            color: #ff2d2d;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 10px;
            line-height: 1.2;
            letter-spacing: 0;
            white-space: pre;
            margin: 0;
        }
        .boot-tagline {
            color: #666;
            font-family: 'Menlo', monospace;
            font-size: 12px;
            margin-top: 16px;
            letter-spacing: 4px;
            text-transform: lowercase;
        }
        .boot-cursor {
            color: #ff2d2d;
            font-family: 'Menlo', monospace;
            font-size: 13px;
            margin-top: 24px;
        }
        .blink {
            animation: blink-anim 0.8s step-end infinite;
        }
        @keyframes blink-anim {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</div>
<div id="app">
    <!-- TOP BAR (single unified bar: menus + file status + transport + history) -->
    <div id="topbar">
        <span class="logo">Entropic</span>
        <div class="menu-item" onclick="openMenu('file-menu')">File
            <div class="menu-dropdown" id="file-menu">
                <button onclick="menuAction('import')">Open File... <span class="menu-shortcut">&#8984;O</span></button>
                <button onclick="menuAction('export')">Export... <span class="menu-shortcut">&#8984;E</span></button>
                <hr>
                <button onclick="menuAction('save-preset')">Save Preset <span class="menu-shortcut">&#8984;S</span></button>
            </div>
        </div>
        <div class="menu-item" onclick="openMenu('edit-menu')">Edit
            <div class="menu-dropdown" id="edit-menu">
                <button onclick="menuAction('undo')">Undo <span class="menu-shortcut">&#8984;Z</span></button>
                <button onclick="menuAction('redo')">Redo <span class="menu-shortcut">&#8984;&#8679;Z</span></button>
                <hr>
                <button onclick="menuAction('randomize')">Randomize Chain</button>
                <button onclick="menuAction('refresh')">Refresh Preview</button>
            </div>
        </div>
        <div class="menu-item" onclick="openMenu('view-menu')">View
            <div class="menu-dropdown" id="view-menu">
                <button onclick="menuAction('toggle-histogram')">Toggle Histogram</button>
                <button onclick="menuAction('toggle-sidebar')">Toggle Sidebar <span class="menu-shortcut">Tab</span></button>
                <hr>
                <button onclick="menuAction('toggle-diff')">Split Compare</button>
                <button onclick="menuAction('popout-preview')">Pop Out Preview</button>
                <button onclick="menuAction('fullscreen-preview')">Fullscreen Preview</button>
                <hr>
                <button onclick="menuAction('shortcuts')">Keyboard Shortcuts</button>
            </div>
        </div>
        <input type="file" id="file-input" accept="video/*,image/*,.gif,.pdf,.zip,.txt,.csv,.json,.xml,.html,.doc,.docx,.wav,.mp3,.aiff,.flac,.psd,.ai,.svg" style="display:none">
        <span id="file-name" class="file-status">No file loaded</span>
        <div class="transport-bar">
            <button class="transport-btn" id="transport-play" onclick="togglePlayback()" title="Play/Pause (Space)">&#9654;</button>
            <button class="transport-btn" id="transport-rec" onclick="toggleRecord()" title="Record (R)">&#9679;</button>
            <button class="transport-btn" id="transport-overdub" onclick="toggleOverdub()" title="Overdub (Shift+R)">&#9678;</button>
            <button class="transport-btn" id="transport-capture" onclick="capturePerformBuffer()" title="Capture (Cmd+Shift+C)">&#8865;</button>
            <button class="transport-btn" id="transport-loop" onclick="toggleLoop()" title="Loop (L)">⟳</button>
            <button class="transport-btn" id="kbd-midi-btn" onclick="toggleKeyboardMidi()" title="Keyboard MIDI (M)">KBD</button>
            <span class="transport-time" id="transport-timecode">0:00:00 / 0:00:00</span>
            <span class="transport-frames" id="transport-frames">F:0/0</span>
        </div>
        <div class="topbar-spacer"></div>
        <button onclick="randomizeChain()" title="Randomize effects" class="icon-btn">Rand</button>
        <button onclick="previewChain()" title="Refresh preview (Cmd+R)" class="icon-btn">&#8635;</button>
        <button id="history-btn" onclick="toggleHistoryDropdown()" title="History" class="icon-btn">History &#9662;</button>
    </div>

    <!-- LEFT SIDEBAR: Effect Browser + Presets -->
    <div id="browser">
        <button id="browser-collapse-btn" onclick="toggleBrowser()" title="Collapse browser (Tab)">&#9664;</button>
        <div class="drag-divider drag-divider-v" id="divider-browser" data-resize="browser"></div>
        <div id="browser-tabs">
            <button class="browser-tab active" data-btab="effects" onclick="switchBrowserTab('effects')">Effects</button>
            <button class="browser-tab" data-btab="presets" onclick="switchBrowserTab('presets')">Presets</button>
        </div>
        <div id="effects-panel" class="browser-panel active">
            <div id="browser-search-bar">
                <input type="text" id="browser-search" placeholder="Search effects..." oninput="onBrowserSearch(this.value)" autocomplete="off" spellcheck="false">
            </div>
            <div id="browser-view-toggle">
                <button class="view-btn active" data-view="category" onclick="switchBrowserView('category')">Category</button>
                <button class="view-btn" data-view="package" onclick="switchBrowserView('package')">Package</button>
                <button class="view-btn" data-view="favorites" onclick="switchBrowserView('favorites')">&#9733;</button>
            </div>
            <div id="effect-list"></div>
        </div>
        <div id="presets-panel" class="browser-panel">
            <div id="preset-list"></div>
            <div class="preset-actions">
                <button onclick="saveCurrentAsPreset()" title="Save current chain as preset">Save Preset</button>
            </div>
        </div>
    </div>

    <!-- CENTER: Video Preview Canvas -->
    <div id="canvas-area">
        <div id="empty-state">
            <div class="icon">&#9654;</div>
            <p>Load a file to start</p>
            <p class="hint">Drop video, image, GIF — or anything else for creative interpretation</p>
        </div>
        <img id="preview-img" style="display:none">
        <div id="preview-controls">
            <button onclick="togglePlayback()" class="preview-ctrl-btn" id="preview-play" title="Play/Pause">&#9654;</button>
            <div id="preview-progress-bar" onclick="clickScrubPreview(event)">
                <div id="preview-progress-fill"></div>
                <input type="range" id="preview-scrubber" min="0" max="100" value="0" oninput="scrubPreview(this.value)">
            </div>
            <button onclick="toggleDiffToolbar()" class="preview-ctrl-btn" title="Split Compare">&#9645;</button>
            <button onclick="fullscreenPreview()" class="preview-ctrl-btn" title="Fullscreen">&#9974;</button>
        </div>
        <div id="perf-hud" style="display:none">
            <span id="perf-hud-rec"></span>
            <span id="perf-hud-time"></span>
            <span id="perf-hud-events"></span>
            <span id="perf-hud-buffer"></span>
            <span id="perf-hud-keyboard" style="display:none;color:#b266ff;font-weight:700;">PERFORM</span>
        </div>
        <div id="keyboard-hint-overlay" style="display:none">
            <div class="key-hint"><kbd>Q</kbd> L1</div>
            <div class="key-hint"><kbd>W</kbd> L2</div>
            <div class="key-hint"><kbd>E</kbd> L3</div>
            <div class="key-hint"><kbd>R</kbd> L4</div>
            <div class="key-hint"><kbd>A</kbd> L5</div>
            <div class="key-hint"><kbd>S</kbd> L6</div>
            <div class="key-hint"><kbd>D</kbd> L7</div>
            <div class="key-hint"><kbd>F</kbd> L8</div>
        </div>
        <div id="frame-info"></div>
        <!-- Diff tools hidden — accessible via View menu only -->
        <div id="diff-toolbar" style="display:none">
            <button onclick="diffCapture()">Capture</button>
            <button onclick="diffShow('diff')">Diff</button>
            <button onclick="diffShow('split')">Split</button>
            <button onclick="diffClear()">Clear</button>
        </div>
        <canvas id="diff-canvas" style="display:none"></canvas>
        <!-- Frame scrubber hidden: timeline handles all scrubbing -->
        <div id="frame-scrubber" style="display:none">
            <input type="range" id="frame-slider" min="0" max="100" value="0">
        </div>
    </div>

    <!-- RIGHT SIDEBAR: hidden (Devices tab redundant with timeline layers) -->
    <div id="right-panel" style="display:none">
        <div id="panel-tabs">
            <button class="panel-tab active" data-tab="layers">Devices</button>
            <button class="panel-tab" data-tab="history">History</button>
        </div>

        <!-- Layers Tab -->
        <div id="layers-tab" class="tab-content active">
            <div id="layers-list"></div>
        </div>

        <!-- History Tab -->
        <div id="history-tab" class="tab-content">
            <div id="history-list"></div>
        </div>
    </div>

    <!-- DRAG DIVIDER: canvas / timeline height -->
    <div class="drag-divider drag-divider-h" id="divider-canvas-timeline" data-resize="canvas-timeline"></div>

    <!-- TIMELINE: between canvas and chain -->
    <div id="timeline-area">
        <div id="timeline-header">
            <span class="collapse-toggle" onclick="togglePanel('timeline-area')">&#9660;</span>
            <span>Timeline</span>
            <div class="timeline-controls">
                <button onclick="timelineEditor.zoomIn()" title="Zoom In (+)">+</button>
                <button onclick="timelineEditor.zoomOut()" title="Zoom Out (-)">-</button>
                <button onclick="timelineEditor.fitToWindow()" title="Fit to Window (Cmd+0)">Fit</button>
            </div>
        </div>
        <div id="timeline-canvas-wrapper">
            <canvas id="timeline-canvas"></canvas>
        </div>
    </div>

    <!-- PERFORM: Transport Bar (between preview and mixer) -->
    <div id="perform-transport" style="display:none">
        <div class="transport-left">
            <button id="perf-play-btn" onclick="perfTogglePlay()" title="Space" data-tooltip="Play/pause perform mode playback" onmouseenter="showInfoViewText('PLAY: Start or pause perform mode playback (Space). Layers render at 15fps preview rate.')" onmouseleave="showInfoViewText('')">&#9654; Play</button>
            <button id="perf-rec-btn" onclick="perfToggleRecord()" title="R" data-tooltip="Toggle explicit recording — captures trigger events to session" onmouseenter="showInfoViewText('REC: Toggle explicit recording (R). Events are captured to a session buffer. Stop to Review, Bake to Timeline, Save, or Discard.')" onmouseleave="showInfoViewText('')">&#9679; Rec</button>
            <button id="perf-auto-btn" onclick="toggleAutoRecording()" title="Shift+R" data-tooltip="Arm automation recording — knob movements are captured as timeline automation lanes" onmouseenter="showInfoViewText('AUTO: Arm automation recording (Shift+R). Move any knob during playback to record parameter changes as timeline automation lanes.')" onmouseleave="showInfoViewText('')">AUTO</button>
            <button id="perf-capture-btn" onclick="capturePerformBuffer()" title="Cmd+Shift+C" data-tooltip="Capture retroactive buffer — claim the last 60s of performance input" onmouseenter="showInfoViewText('CAPTURE: Claim the last 60 seconds of performance input without having pressed Record (Cmd+Shift+C). Like Ableton MIDI Capture.')" onmouseleave="showInfoViewText('')">Capture</button>
            <button onclick="perfPanic()" title="Shift+P" data-tooltip="Panic — reset all layers to default state" onmouseenter="showInfoViewText('PANIC: Immediately reset all layer states, stop envelopes, clear triggers (Shift+P).')" onmouseleave="showInfoViewText('')">&#8634; Panic</button>
            <button id="perf-loop-btn" onclick="perfToggleLoop()" title="Loop">&#10226; Loop</button>
        </div>
        <div class="transport-center">
            <span id="perf-time">0:00:00</span> / <span id="perf-duration">--:--</span>
            <span id="perf-frame">F:0</span>
            <div id="perf-scrubber"><input type="range" min="0" max="100" value="0" oninput="perfScrub(this.value)"></div>
        </div>
        <div class="transport-right">
            <span id="perf-event-count">0 events</span>
            <button onclick="perfSaveSession()">Save</button>
            <button onclick="perfRender()" class="primary">Render</button>
        </div>
    </div>

    <!-- PERFORM: Mixer Panel (4 channel strips + master) -->
    <div id="perform-panel" style="display:none">
        <div id="mixer"><!-- Rendered by JS: renderMixer() --></div>
    </div>

    <!-- INFO VIEW: feature-flagged off (too cluttered, needs more work) -->
    <div id="info-view" style="display:none">
        <div class="info-view-label">Info</div>
        <div id="info-view-content">Hover over any control, effect, or panel element to see details here.</div>
    </div>

    <!-- DRAG DIVIDER: timeline / chain height -->
    <div class="drag-divider drag-divider-h" id="divider-timeline-chain" data-resize="timeline-chain"></div>

    <!-- BOTTOM: Effect Chain Rack -->
    <div id="chain-area">
        <div id="chain-header">
            <span class="collapse-toggle" onclick="togglePanel('chain-area')">&#9660;</span>
            <span>Effect Chain</span>
            <span class="count" id="chain-count">0 devices</span>
            <span id="chain-complexity" title="Click to clear frame cache" onclick="clearFrameCache();updateChainComplexity(_countDevices(chain));showToast('Frame cache cleared','info',null,1500)" style="cursor:pointer"></span>
            <!-- histogram toggle moved to View menu -->
        </div>
        <div id="histogram-panel" class="collapsed" style="display:none">
            <div id="histogram-header" onclick="toggleHistogramPanel()">
                <span id="histogram-arrow">&#9660;</span>
                <span>Histogram</span>
            </div>
            <div id="histogram-canvas-wrap">
                <canvas id="histogram-canvas" width="256" height="100"></canvas>
            </div>
        </div>
        <div id="chain-content">
            <div id="lfo-panel"></div>
            <div id="chain-rack"></div>
        </div>
    </div>

    <!-- Theme flip switch (fixed position, bottom-right) -->
    <div id="theme-switch" onclick="toggleTheme()" title="Toggle light/dark theme">
        <div class="switch-track"><div class="switch-thumb"></div></div>
        <span class="switch-label">&#9790;</span>
    </div>

    <!-- History Dropdown (anchored near topbar) -->
    <div id="history-dropdown" style="display:none">
        <div id="history-dropdown-header">
            <span>History</span>
            <button onclick="toggleHistoryDropdown()" class="modal-close">&times;</button>
        </div>
        <div id="history-dropdown-list"></div>
    </div>
</div>

<!-- Export Dialog (modal) -->
<div id="export-overlay" class="modal-overlay" style="display:none">
    <div class="modal-dialog export-dialog">
        <div class="modal-header">
            <h2>Export</h2>
            <button onclick="closeExportDialog()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="export-row">
                <label>Format</label>
                <select id="export-format" onchange="onExportFormatChange()">
                    <option value="mp4">MP4 (H.264) — Web/Social</option>
                    <option value="mov">MOV (ProRes) — Editing Pipeline</option>
                    <option value="gif">GIF — Short Loops</option>
                    <option value="png_seq">PNG Sequence — Compositing</option>
                    <option value="webm">WebM (VP9) — Web Embed</option>
                </select>
            </div>
            <div class="export-row">
                <label>Resolution</label>
                <select id="export-resolution" onchange="onExportResChange()">
                    <option value="source">Match Source</option>
                    <option value="480p">480p (854x480)</option>
                    <option value="720p">720p (1280x720)</option>
                    <option value="1080p" selected>1080p (1920x1080)</option>
                    <option value="2k">2K (2560x1440)</option>
                    <option value="4k">4K (3840x2160)</option>
                    <option value="instagram_square">Instagram Square (1080x1080)</option>
                    <option value="instagram_story">Instagram Story (1080x1920)</option>
                    <option value="tiktok">TikTok (1080x1920)</option>
                    <option value="custom">Custom...</option>
                </select>
            </div>
            <div class="export-row" id="custom-dims-row" style="display:none">
                <label>Dimensions</label>
                <div class="dim-inputs">
                    <input type="number" id="export-width" placeholder="Width" min="16" max="7680">
                    <span>&times;</span>
                    <input type="number" id="export-height" placeholder="Height" min="16" max="4320">
                </div>
            </div>
            <div class="export-row">
                <label>Scale</label>
                <select id="export-scale">
                    <option value="">From Resolution</option>
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1.0">100%</option>
                    <option value="1.5">150%</option>
                    <option value="2.0">200%</option>
                </select>
            </div>
            <div class="export-row" id="h264-quality-row">
                <label>Quality (CRF)</label>
                <input type="range" id="export-crf" min="0" max="51" value="23" oninput="document.getElementById('crf-val').textContent=this.value">
                <span id="crf-val">23</span>
                <span class="hint">(lower = better)</span>
            </div>
            <div class="export-row" id="h264-preset-row">
                <label>Speed</label>
                <select id="export-h264-preset">
                    <option value="ultrafast">Ultrafast</option>
                    <option value="fast">Fast</option>
                    <option value="medium" selected>Medium</option>
                    <option value="slow">Slow (better compression)</option>
                    <option value="veryslow">Very Slow (best compression)</option>
                </select>
            </div>
            <div class="export-row" id="prores-row" style="display:none">
                <label>ProRes Profile</label>
                <select id="export-prores">
                    <option value="proxy">Proxy (smallest)</option>
                    <option value="lt">LT (light)</option>
                    <option value="422" selected>422 (standard)</option>
                    <option value="422hq">422 HQ (high quality)</option>
                    <option value="4444">4444 (with alpha)</option>
                </select>
            </div>
            <div class="export-row" id="gif-row" style="display:none">
                <label>GIF Colors</label>
                <input type="range" id="export-gif-colors" min="2" max="256" value="256" oninput="document.getElementById('gif-colors-val').textContent=this.value">
                <span id="gif-colors-val">256</span>
            </div>
            <div class="export-row">
                <label>Frame Rate</label>
                <select id="export-fps">
                    <option value="">Match Source</option>
                    <option value="24">24 fps (Film)</option>
                    <option value="25">25 fps (PAL)</option>
                    <option value="29.97">29.97 fps (NTSC)</option>
                    <option value="30">30 fps</option>
                    <option value="60">60 fps</option>
                </select>
            </div>
            <div class="export-row">
                <label>Audio</label>
                <select id="export-audio">
                    <option value="copy">Copy from source</option>
                    <option value="reencode">Re-encode (AAC)</option>
                    <option value="strip">Strip audio</option>
                </select>
            </div>
            <div class="export-row">
                <label>Range</label>
                <select id="export-range" onchange="onExportRangeChange()">
                    <option value="full">Full Video</option>
                    <option value="playhead">From Playhead</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="export-row" id="export-duration-row" style="display:none">
                <label>Duration (sec)</label>
                <input type="number" id="export-duration" min="1" max="600" value="30" step="1">
                <span class="hint">seconds from playhead</span>
            </div>
            <div class="export-row" id="export-range-row" style="display:none">
                <label>In / Out (sec)</label>
                <div class="dim-inputs">
                    <input type="number" id="export-in" placeholder="Start" min="0" step="0.1" value="0">
                    <span>to</span>
                    <input type="number" id="export-out" placeholder="End" min="0" step="0.1">
                </div>
            </div>
            <div class="export-row">
                <label>Scaling Algorithm</label>
                <select id="export-algo">
                    <option value="lanczos" selected>Lanczos (best quality)</option>
                    <option value="bilinear">Bilinear (fast)</option>
                    <option value="bicubic">Bicubic</option>
                    <option value="nearest">Nearest (pixel art)</option>
                </select>
            </div>
            <div class="export-row">
                <label>Mix (Effect Intensity)</label>
                <input type="range" id="export-mix" min="0" max="100" value="100" oninput="document.getElementById('export-mix-val').textContent=this.value+'%'">
                <span id="export-mix-val">100%</span>
                <span class="hint">0% = original, 100% = full effect</span>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeExportDialog()">Cancel</button>
            <button onclick="startExport()" class="primary" id="export-go-btn">Export</button>
        </div>
    </div>
</div>

<!-- Server-Down Banner -->
<div id="server-banner" class="server-banner" style="display:none">
    <span>Engine disconnected</span>
    <button onclick="restartServer()">Restart</button>
</div>

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Generic Input Modal -->
<div id="input-modal-overlay" class="modal-overlay" style="display:none">
    <div class="modal-dialog input-modal-dialog">
        <div class="modal-header">
            <h2 id="input-modal-title">Input</h2>
            <button onclick="closeInputModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <input type="text" id="input-modal-field" class="modal-input" placeholder="">
        </div>
        <div class="modal-footer">
            <button onclick="closeInputModal()">Cancel</button>
            <button onclick="submitInputModal()" class="primary">OK</button>
        </div>
    </div>
</div>

<!-- Shortcut Reference Card (? key) -->
<div id="shortcut-overlay" class="modal-overlay" style="display:none">
    <div class="modal-dialog shortcut-dialog">
        <div class="modal-header">
            <h2>Keyboard Shortcuts</h2>
            <button onclick="closeShortcutRef()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body shortcut-body">
            <div class="shortcut-col">
                <h3 data-shortcut-mode="common">Chain Editing</h3>
                <div class="sc-row"><kbd>Cmd+D</kbd> Duplicate effect</div>
                <div class="sc-row"><kbd>Del</kbd> Remove effect</div>
                <div class="sc-row"><kbd>[</kbd> <kbd>]</kbd> Move up/down</div>
                <div class="sc-row"><kbd>B</kbd> Bypass toggle</div>
                <div class="sc-row"><kbd>R</kbd> Reset to defaults</div>
                <div class="sc-row"><kbd>&uarr;</kbd> <kbd>&darr;</kbd> Select prev/next</div>
                <div class="sc-row"><kbd>Cmd+G</kbd> Create group</div>
                <div class="sc-row"><kbd>Cmd+Shift+G</kbd> Ungroup</div>
                <h3 data-shortcut-mode="common">Parameters</h3>
                <div class="sc-row"><kbd>Drag</kbd> Adjust knob</div>
                <div class="sc-row"><kbd>Shift+Drag</kbd> Fine adjust</div>
                <div class="sc-row"><kbd>Dbl-click</kbd> Reset to default</div>
            </div>
            <div class="shortcut-col">
                <h3 data-shortcut-mode="common">Preview</h3>
                <div class="sc-row"><kbd>Space</kbd> A/B compare</div>
                <div class="sc-row"><kbd>P</kbd> Toggle Perform panel</div>
                <div class="sc-row"><kbd>&larr;</kbd> <kbd>&rarr;</kbd> Prev/next frame</div>
                <div class="sc-row"><kbd>Shift+&larr;</kbd> <kbd>Shift+&rarr;</kbd> Jump 10</div>
                <h3 data-shortcut-mode="common">File</h3>
                <div class="sc-row"><kbd>Cmd+O</kbd> Open file</div>
                <div class="sc-row"><kbd>Cmd+E</kbd> Export</div>
                <div class="sc-row"><kbd>Cmd+S</kbd> Save preset</div>
                <h3 data-shortcut-mode="common">UI</h3>
                <div class="sc-row"><kbd>Tab</kbd> Toggle sidebar</div>
                <div class="sc-row"><kbd>Esc</kbd> Close modal</div>
                <div class="sc-row"><kbd>H</kbd> Help panel</div>
                <div class="sc-row"><kbd>?</kbd> This reference</div>
                <h3 data-shortcut-mode="timeline">Timeline</h3>
                <div class="sc-row"><kbd>I</kbd> Set in-point</div>
                <div class="sc-row"><kbd>O</kbd> Set out-point</div>
                <div class="sc-row"><kbd>Cmd+R</kbd> Create region</div>
                <div class="sc-row"><kbd>Space</kbd> Play/Pause</div>
                <div class="sc-row"><kbd>Home</kbd> Jump to start</div>
                <div class="sc-row"><kbd>End</kbd> Jump to end</div>
                <div class="sc-row"><kbd>+ / -</kbd> Zoom in/out</div>
                <div class="sc-row"><kbd>Cmd+0</kbd> Fit to window</div>
                <div class="sc-row"><kbd>M</kbd> Mute track</div>
                <div class="sc-row"><kbd>S</kbd> Solo track</div>
                <h3 data-shortcut-mode="perform">Perform</h3>
                <div class="sc-row"><kbd>1-8</kbd> Trigger layers (one-shot)</div>
                <div class="sc-row"><kbd>Space</kbd> Play/Pause</div>
                <div class="sc-row"><kbd>R</kbd> Toggle recording</div>
                <div class="sc-row"><kbd>Shift+R</kbd> Automation record (knobs)</div>
                <div class="sc-row"><kbd>Shift+P</kbd> Panic (reset all)</div>
                <div class="sc-row"><kbd>Cmd+Shift+C</kbd> Capture buffer</div>
                <h3 data-shortcut-mode="perform">Keyboard Perform</h3>
                <div class="sc-row"><kbd>M</kbd> Toggle keyboard mode</div>
                <div class="sc-row"><kbd>Q/W/E/R</kbd> Trigger L1-L4</div>
                <div class="sc-row"><kbd>A/S/D/F</kbd> Trigger L5-L8</div>
                <div class="sc-row"><kbd>K</kbd> Toggle key hints</div>
                <div class="sc-row"><kbd>Esc</kbd> Panic + exit mode</div>
            </div>
        </div>
    </div>
</div>

<!-- Help Panel (H key) -->
<div id="help-overlay" class="modal-overlay" style="display:none">
    <div class="modal-dialog help-dialog">
        <div class="modal-header">
            <h2>Help</h2>
            <button onclick="closeHelpPanel()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body help-body">
            <div class="help-section">
                <h3>Quick Start</h3>
                <ol class="help-steps">
                    <li>Load a video, image, or GIF with <kbd>Cmd+O</kbd> or drag &amp; drop</li>
                    <li>Browse effects in the left sidebar and drag them into the chain</li>
                    <li>Adjust parameters with the Moog-style knobs (drag up/down)</li>
                    <li>Preview updates automatically &mdash; press <kbd>Space</kbd> to compare original</li>
                    <li>Export with <kbd>Cmd+E</kbd> when you're happy with the result</li>
                </ol>
            </div>
            <div class="help-section">
                <h3>Effect Reference</h3>
                <input type="text" id="help-search" placeholder="Search effects..." class="modal-input" oninput="filterHelpEffects(this.value)">
                <div id="help-effect-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu (shared, repositioned dynamically) -->
<div id="ctx-menu" class="ctx-menu"></div>

<script src="/static/timeline.js"></script>
<script src="/static/app.js"></script>
</body>
</html>
